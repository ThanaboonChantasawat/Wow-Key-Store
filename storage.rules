rules_version = '2';

// Craft rules based on data in your Firestore database
// allow write: if firestore.get(
//    /databases/(default)/documents/users/$(request.auth.uid)).data.isAdmin;
service firebase.storage {
  match /b/{bucket}/o {
    
    // อนุญาตให้อ่านได้ทุกคน
    match /{allPaths=**} {
      allow read: if true;
    }

    // Shop logos - เฉพาะผู้ใช้ที่ login แล้วเท่านั้นที่อัปโหลดได้
    match /shop-logos/{userId}/{fileName} {
      allow write: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // Product images - เฉพาะผู้ใช้ที่ login แล้วเท่านั้นที่อัปโหลดได้
    match /products/{productId}/{fileName} {
      allow write: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // Profile images - เฉพาะเจ้าของเท่านั้น
    match /profile-images/{userId}/{fileName} {
      allow write: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Game images - เฉพาะผู้ใช้ที่ login (ชั่วคราวอนุญาตทุกคนที่ login แล้ว)
    // TODO: เปลี่ยนเป็นเช็ค admin role หลังจาก IAM permissions ตั้งค่าเสร็จ
    match /game-images/{fileName} {
      allow write: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // Reopen documents - เจ้าของร้านอัปโหลด, admin ลบได้
    match /reopen-documents/{shopId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
      allow delete: if request.auth != null && 
        firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }
  }
}
